<?php
$formdata = !empty($this -> vars['formModel']->attributes) ? $this -> vars['formModel']->attributes : [];
$customer_data = isset($this -> vars['formModel']->customer_data->attributes) ? $this -> vars['formModel']->customer_data->attributes : null;
?>
<input
  type="hidden"
  name="Orders[customer_id]"
  id="Form-field-Orders-customer_id"
  required
  class="form-control"
  value="<?php echo isset($formdata) && $formdata['customer_id'] != 0 ? $customer_data['id'] : null; ?>">

<div>
  <div class="row">
    <div class="col-sm-6">
      <div class="customer-browser" style="<?php echo !isset($formdata) || $formdata['customer_id'] == 0 ? null : 'display:none;'; ?>">
        <label>Búsqueda</label>
        <input type="search" class="form-control" id="data-customer-search">
        <div class="text-right" style="margin: 5px 0;">
          <button onclick="searchCustomer()" type="button" class="btn btn-info btn-sm">Buscar</button>
        </div>
      </div>
    </div>
    <div class="col-sm-6">
      <div class="customer-results" style="display: none;">
        <label>Resultados</label>
        <select
        onchange="attachcustomer()"
        class="form-control"
        id="order-customer-result">
        </select>
      </div>
    </div>
  </div>
  
  <div class="customer-attached" style="<?php echo isset($formdata) && $formdata['customer_id'] != 0 ? null : 'display:none;'; ?>">
    <div class="row">
      <div class="col-sm-9">
        <input
          type="text"
          id="customer-name"
          readonly
          class="form-control"
          value="<?php echo isset($formdata) && $formdata['customer_id'] != 0 ? $customer_data['customer_name'] . ' ' .$customer_data['customer_lastname'] : null; ?>">
      </div>
      <div class="col-sm-3">
        <button onclick="removeCustomerAttached()" type="button" class="btn btn-danger"><i class="icon icon-times"></i></button>
      </div>
    </div>
  </div>
</div>

<script>
function searchCustomer(){
  let data = document.getElementById('data-customer-search').value
  if(data.replace(/\s+/g, '').length <= 0) return false
  $(this).request('onSearchCustomer', {
    data: {
      data_customer: data
    },
    success: (res) => {
      $('.customer-results').css({'display': 'block'})
      let template = ''
      if(res.length > 0){  
        template += '<option value="">Selecciona una opción</option>'
        res.forEach(e => {
          template += `<option value='${JSON.stringify(e)}'>${e.customer_name} ${e.customer_lastname}</option>`
        });
      }else{
        template += '<option value="">No existen resultados</option>'
      }
      $('#order-customer-result').html(template)
    }
  })
}

function attachcustomer(){
  document.querySelector('.customer-attached').style.display = 'block'
  document.querySelector('.customer-results').style.display = 'none'
  document.querySelector('.customer-browser').style.display = 'none'
  let value = document.getElementById('order-customer-result').value
  let input_id = document.getElementById('Form-field-Orders-customer_id')
  let input_name = document.getElementById('customer-name')
  value = JSON.parse(value)
  input_id.value = value.id
  input_name.value = value.customer_name + ' ' + value.customer_lastname
}

function removeCustomerAttached(){
  let input_results = document.getElementById('order-customer-result')
  let input_id = document.getElementById('Form-field-Orders-customer_id')
  let input_name = document.getElementById('customer-name')
  input_results.value = ''
  input_results.value = ''
  input_name.value = ''
  document.querySelector('.customer-attached').style.display = 'none'
  document.querySelector('.customer-results').style.display = 'none'
  document.querySelector('.customer-browser').style.display = 'block'
}

</script>
